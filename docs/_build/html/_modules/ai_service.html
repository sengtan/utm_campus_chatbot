

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ai_service &mdash; UTM Campus Assistant Chatbot 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=8d563738"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            UTM Campus Assistant Chatbot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">Configuration and Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../admin_guide.html">Administrator Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_management.html">User Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../facility_management.html">Facility Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">UTM Campus Assistant Chatbot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">ai_service</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ai_service</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="c1"># Assuming models.py is correctly defined and accessible</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Facility</span><span class="p">,</span> <span class="n">IssueType</span><span class="p">,</span> <span class="n">Priority</span> 

<div class="viewcode-block" id="AIService">
<a class="viewcode-back" href="../api_reference.html#ai_service.AIService">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AIService</span><span class="p">:</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># DeepSeek API configuration - adjust URL to your local setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;https://openrouter.ai/api/v1/chat/completions&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_MODEL&quot;</span><span class="p">,</span> <span class="s2">&quot;deepseek/deepseek-chat-v3-0324:free&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DEEPSEEK_API_KEY&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Optional, if your API requires a key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_facilities</span><span class="p">()</span>
    
<div class="viewcode-block" id="AIService.load_facilities">
<a class="viewcode-back" href="../api_reference.html#ai_service.AIService.load_facilities">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_facilities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load facilities from database for context&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import app and db within the method to avoid circular imports</span>
            <span class="c1"># if AIService is initialized before app/db. This is a common pattern.</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">flask_app</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">db</span> 
            <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>
                <span class="n">facilities</span> <span class="o">=</span> <span class="n">Facility</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">category</span><span class="p">,</span>
                        <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">location</span><span class="p">,</span>
                        <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;is_bookable&#39;</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">is_bookable</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">facilities</span>
                <span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span><span class="p">)</span><span class="si">}</span><span class="s2"> facilities into cache.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading facilities: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span> <span class="o">=</span> <span class="p">[]</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_remove_think_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove &lt;think&gt;...&lt;/think&gt; tags and their content from the model response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;think&gt;.*?&lt;/think&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_json_from_llm_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_content</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to extract and parse a JSON object from a potentially</span>
<span class="sd">        markdown-wrapped or raw LLM response string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Remove &lt;think&gt;...&lt;/think&gt; tags if present</span>
        <span class="n">cleaned_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_think_tags</span><span class="p">(</span><span class="n">raw_content</span><span class="p">)</span>
        <span class="c1"># Regex to find JSON within ```json ... ``` or ``` ... ``` code blocks</span>
        <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;```(?:json)?\s*(.*?)\s*```&quot;</span><span class="p">,</span> <span class="n">cleaned_content</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
            <span class="n">json_string</span> <span class="o">=</span> <span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_string</span> <span class="o">=</span> <span class="n">cleaned_content</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c1"># Assume it&#39;s just the JSON string</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>

<div class="viewcode-block" id="AIService.extract_entities_and_intent">
<a class="viewcode-back" href="../api_reference.html#ai_service.AIService.extract_entities_and_intent">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_entities_and_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract entities and classify intent from user message using AI&quot;&quot;&quot;</span>
        <span class="c1"># Ensure facilities_cache is loaded</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_facilities</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">facilities_context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) at </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span><span class="p">[:</span><span class="mi">20</span><span class="p">]</span>  <span class="c1"># Limit context size</span>
            <span class="p">])</span>
            
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Analyze the following user message and extract entities and classify intent.</span>
<span class="s2">            </span>
<span class="s2">            Available facilities for context:</span>
<span class="s2">            </span><span class="si">{</span><span class="n">facilities_context</span><span class="si">}</span>
<span class="s2">            </span>
<span class="s2">            User message: &quot;</span><span class="si">{</span><span class="n">user_message</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">            </span>
<span class="s2">            Extract and classify the following:</span>
<span class="s2">            1. Intent: One of [search, explore, book, report_issue, check_status, general_info]</span>
<span class="s2">            2. Entities:</span>
<span class="s2">               - Facility: name of facility mentioned (if any), e.g., &quot;Computer Lab 1&quot;, &quot;Library&quot;</span>
<span class="s2">               - Location: specific location mentioned (if any), e.g., &quot;Block A&quot;, &quot;Level 2&quot;</span>
<span class="s2">               - Issue_type: if reporting issue, one of [electrical, hygiene, structural, equipment, security, other]</span>
<span class="s2">               - Component: specific component/equipment mentioned (if any), e.g., &quot;projector&quot;, &quot;toilet&quot;, &quot;AC unit&quot;</span>
<span class="s2">            </span>
<span class="s2">            Your response must be a valid JSON object. Do not include any text before or after the JSON.</span>
<span class="s2">            The JSON structure should be:</span>
<span class="s2">            </span><span class="se">{{</span>
<span class="s2">                &quot;intent&quot;: &quot;intent_name&quot;,</span>
<span class="s2">                &quot;entities&quot;: </span><span class="se">{{</span>
<span class="s2">                    &quot;facility&quot;: &quot;facility_name or null&quot;,</span>
<span class="s2">                    &quot;location&quot;: &quot;location or null&quot;,</span>
<span class="s2">                    &quot;issue_type&quot;: &quot;issue_type or null&quot;,</span>
<span class="s2">                    &quot;component&quot;: &quot;component or null&quot;</span>
<span class="s2">                </span><span class="se">}}</span><span class="s2">,</span>
<span class="s2">                &quot;confidence&quot;: 0.0-1.0</span>
<span class="s2">            </span><span class="se">}}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span> <span class="k">else</span> <span class="p">{}</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_model</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an expert in natural language processing for campus facility management. Always respond ONLY with valid JSON, strictly adhering to the specified schema. Do not include any conversational text or markdown code blocks (e.g., ```json).&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                    <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">300</span>
                <span class="p">},</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="c1"># Ensure full JSON response at once</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="c1"># Increased timeout</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> <span class="c1"># Raises HTTPError for bad responses (4xx or 5xx)</span>
            
            <span class="n">result_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="c1"># Correctly access content from Ollama&#39;s /api/chat response</span>
            <span class="c1"># model_raw_content = result_data.get(&quot;message&quot;, {}).get(&quot;content&quot;, &quot;&quot;)</span>

            <span class="c1"># For OpenRouter.ai: extract content from choices[0][&#39;message&#39;][&#39;content&#39;]</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">model_raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">choices</span> <span class="ow">and</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">model_raw_content</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_raw_content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model returned empty content for entity &amp; intent extraction.&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_json_from_llm_response</span><span class="p">(</span><span class="n">model_raw_content</span><span class="p">)</span>

            <span class="c1"># Basic validation and default values</span>
            <span class="n">extracted_intent</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intent&quot;</span><span class="p">,</span> <span class="s2">&quot;general_info&quot;</span><span class="p">)</span>
            <span class="n">extracted_entities</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entities&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">extracted_confidence</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;confidence&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># Model might not always provide this</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="n">extracted_intent</span><span class="p">,</span>
                <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;facility&quot;</span><span class="p">:</span> <span class="n">extracted_entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;facility&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">extracted_entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;location&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;issue_type&quot;</span><span class="p">:</span> <span class="n">extracted_entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issue_type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">extracted_entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="p">},</span>
                <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="n">extracted_confidence</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in entity extraction: Request timed out.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;general_info&quot;</span><span class="p">,</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error communicating with Ollama API for entity extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensure &#39;ollama serve&#39; is running and the model is available.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;general_info&quot;</span><span class="p">,</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;API error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing JSON from model response for entity extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw model content was: &#39;</span><span class="si">{</span><span class="n">model_raw_content</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="c1"># Important for debugging</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;general_info&quot;</span><span class="p">,</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;JSON parse error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># For &quot;Model returned empty content&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entity extraction error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;general_info&quot;</span><span class="p">,</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Model output issue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during entity extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;intent&quot;</span><span class="p">:</span> <span class="s2">&quot;general_info&quot;</span><span class="p">,</span> <span class="s2">&quot;entities&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;confidence&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>

    
<div class="viewcode-block" id="AIService.generate_response">
<a class="viewcode-back" href="../api_reference.html#ai_service.AIService.generate_response">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">user_context</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate contextual response based on intent and entities&quot;&quot;&quot;</span>
        <span class="c1"># Ensure facilities_cache is loaded</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_facilities</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">intent</span> <span class="o">=</span> <span class="n">intent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;intent&#39;</span><span class="p">,</span> <span class="s1">&#39;general_info&#39;</span><span class="p">)</span>
            <span class="n">entities</span> <span class="o">=</span> <span class="n">intent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;entities&#39;</span><span class="p">,</span> <span class="p">{})</span>
            
            <span class="c1"># Build context for the LLM</span>
            <span class="n">facilities_context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) at </span><span class="si">{</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> 
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot; - Bookable&quot;</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;is_bookable&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="c1"># Limit context size</span>
            <span class="p">])</span>
            
            <span class="n">context_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            You are the UTM Campus Assistant Chatbot. Your goal is to provide helpful, friendly, and concise information to students regarding campus facilities.</span>

<span class="s2">            **Current Date and Time:** </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;CURRENT_TIME&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Unknown&quot;</span><span class="p">)</span><span class="si">}</span>
<span class="s2">            **Campus Location:** Singapore, Singapore</span>

<span class="s2">            **Available Facilities Information:**</span>
<span class="s2">            </span><span class="si">{</span><span class="n">facilities_context</span><span class="si">}</span>

<span class="s2">            **Current User Input:** &quot;</span><span class="si">{</span><span class="n">user_message</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="s2">            **Current Detected Intent:** </span><span class="si">{</span><span class="n">intent</span><span class="si">}</span>
<span class="s2">            **Current Extracted Entities:** </span><span class="si">{</span><span class="n">entities</span><span class="si">}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="c1"># Build conversation history if user_context is provided (for multi-turn)</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">context_prompt</span><span class="p">},</span>
            <span class="p">]</span>
            <span class="c1"># If you want to maintain a longer conversation, you&#39;d add past messages here</span>
            <span class="k">if</span> <span class="n">user_context</span> <span class="ow">and</span> <span class="n">user_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;history&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">user_context</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]:</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;sender&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;bot&quot;</span><span class="p">,</span><span class="s2">&quot;assistant&quot;</span><span class="p">),</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]})</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">user_message</span><span class="p">})</span>

            <span class="c1"># Add specific guidance for response generation based on intent</span>
            <span class="n">response_guidance</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Based on the above context, provide a helpful and conversational response.</span>

<span class="s2">            - **search/explore intent:** Briefly describe the facility, its location, and primary purpose. If multiple match, list them briefly.</span>
<span class="s2">            - **report_issue intent:** Acknowledge the issue, explain the reporting process (e.g., &quot;Please use the &#39;Report Issue&#39; function...&quot;), and ask for more details if needed (e.g., exact location, severity).</span>
<span class="s2">            - **book intent:** Provide booking information for the facility, or guide them to the booking system/process.</span>
<span class="s2">            - **check_status intent:** Explain how to check the status of a reported issue (e.g., &quot;You can check the status on your dashboard...&quot;).</span>
<span class="s2">            - **general_info intent:** Provide general help, list available services, or ask clarifying questions.</span>

<span class="s2">            Keep your response concise and directly answer the user&#39;s query if possible. If the requested information is not available in your knowledge base, politely state that.</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">response_guidance</span><span class="p">})</span> <span class="c1"># Add this as a guiding message</span>

            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span> <span class="k">else</span> <span class="p">{}</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_model</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="c1"># Use the built messages array</span>
                <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span> <span class="c1"># Slightly higher temperature for more conversational responses</span>
                    <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">500</span>  <span class="c1"># Allow more tokens for the response</span>
                <span class="p">},</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="c1"># Get full response at once</span>
            <span class="p">}</span>
            
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="c1"># Increased timeout</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span> <span class="c1"># Raises HTTPError for bad responses (4xx or 5xx)</span>
            
            <span class="n">result_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="c1"># --- CRITICAL FIX: Correctly access the content from Ollama&#39;s chat API response ---</span>
            <span class="c1"># Ollama&#39;s /api/chat returns: {&quot;model&quot;: ..., &quot;created_at&quot;: ..., &quot;message&quot;: {&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;...&quot;}}</span>
            <span class="c1"># Access directly via &#39;message&#39; key.</span>
            <span class="c1"># model_raw_content = result_data.get(&quot;message&quot;, {}).get(&quot;content&quot;, &quot;&quot;).strip()</span>

            <span class="c1"># For OpenRouter.ai: extract content from choices[0][&#39;message&#39;][&#39;content&#39;]</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">model_raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">choices</span> <span class="ow">and</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">model_raw_content</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_raw_content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model returned empty response content for generation.&quot;</span><span class="p">)</span>

            <span class="c1"># Remove &lt;think&gt;...&lt;/think&gt; tags before returning to user</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_think_tags</span><span class="p">(</span><span class="n">model_raw_content</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating response: Request timed out.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fallback_response</span><span class="p">(</span><span class="n">user_message</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error communicating with Ollama API for response generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please ensure &#39;ollama serve&#39; is running and the model is available.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fallback_response</span><span class="p">(</span><span class="n">user_message</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># For &quot;Model returned empty content&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response generation error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fallback_response</span><span class="p">(</span><span class="n">user_message</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during response generation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fallback_response</span><span class="p">(</span><span class="n">user_message</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">)</span></div>

    
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_fallback_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intent_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate rule-based responses when AI generation fails or is unavailable.&quot;&quot;&quot;</span>
        <span class="n">message_lower</span> <span class="o">=</span> <span class="n">user_message</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">intent</span> <span class="o">=</span> <span class="n">intent_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;intent&#39;</span><span class="p">,</span> <span class="s1">&#39;general_info&#39;</span><span class="p">)</span>
        
        <span class="c1"># Computer lab queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;computer&#39;</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;workstation&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;🖥️ **Computer Lab 1** is located at **Block A, Level 2**. It has 40 workstations and is available for booking. You can use it for coursework and projects.&quot;</span>
        
        <span class="c1"># Library queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;library&#39;</span><span class="p">,</span> <span class="s1">&#39;book&#39;</span><span class="p">,</span> <span class="s1">&#39;study&#39;</span><span class="p">,</span> <span class="s1">&#39;reading&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;📚 The **Library** is located at **Block B, Ground Floor**. It&#39;s open from 8:00 AM to 10:00 PM and provides study spaces and resources for students.&quot;</span>
        
        <span class="c1"># Gymnasium queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gym&#39;</span><span class="p">,</span> <span class="s1">&#39;gymnasium&#39;</span><span class="p">,</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise&#39;</span><span class="p">,</span> <span class="s1">&#39;fitness&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;🏃 The **Gymnasium** is located at the **Sports Complex**. It&#39;s available for booking and hosts various sports activities and fitness programs.&quot;</span>
        
        <span class="c1"># Hostel queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;hostel&#39;</span><span class="p">,</span> <span class="s1">&#39;accommodation&#39;</span><span class="p">,</span> <span class="s1">&#39;dormitory&#39;</span><span class="p">,</span> <span class="s1">&#39;room&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;🏠 We have accommodation facilities:</span><span class="se">\n</span><span class="s2">• **Male Hostel Block C** - Hostel Area</span><span class="se">\n</span><span class="s2">• **Female Hostel Block D** - Hostel Area</span><span class="se">\n\n</span><span class="s2">Both provide student accommodation with necessary amenities.&quot;</span>
        
        <span class="c1"># Cafeteria queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cafeteria&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;dining&#39;</span><span class="p">,</span> <span class="s1">&#39;eat&#39;</span><span class="p">,</span> <span class="s1">&#39;meal&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;🍽️ The **Cafeteria** is located at the **Student Center**. It&#39;s open from 7:00 AM to 9:00 PM and serves meals throughout the day.&quot;</span>
        
        <span class="c1"># Location/where queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;where&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;find&#39;</span><span class="p">]):</span>
            <span class="n">facilities_list</span> <span class="o">=</span> <span class="s2">&quot;📍 **UTM Campus Facilities:**</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="c1"># Ensure facilities_cache is available for fallback</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">facility</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">facilities_cache</span><span class="p">[:</span><span class="mi">6</span><span class="p">]:</span>
                    <span class="n">facilities_list</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;• **</span><span class="si">{</span><span class="n">facility</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">** - </span><span class="si">{</span><span class="n">facility</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">facilities_list</span> <span class="o">+=</span> <span class="s2">&quot;Unable to load facility details at the moment.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">facilities_list</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">What specific facility are you looking for?&quot;</span>
            <span class="k">return</span> <span class="n">facilities_list</span>
        
        <span class="c1"># Issue reporting</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;problem&#39;</span><span class="p">,</span> <span class="s1">&#39;issue&#39;</span><span class="p">,</span> <span class="s1">&#39;broken&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">,</span> <span class="s1">&#39;complaint&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;🔧 To report a facility issue:</span><span class="se">\n</span><span class="s2">1. Go to the **Report Issue** page</span><span class="se">\n</span><span class="s2">2. Describe the problem in detail</span><span class="se">\n</span><span class="s2">3. Select the issue type and location</span><span class="se">\n</span><span class="s2">4. Submit your report</span><span class="se">\n\n</span><span class="s2">You can track the status of your report from your dashboard.&quot;</span>
        
        <span class="c1"># Booking queries</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">message_lower</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;book&#39;</span><span class="p">,</span> <span class="s1">&#39;reserve&#39;</span><span class="p">,</span> <span class="s1">&#39;booking&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s2">&quot;📅 **Facility Booking:**</span><span class="se">\n</span><span class="s2">• Computer Lab 1 - Available for booking</span><span class="se">\n</span><span class="s2">• Gymnasium - Available for booking</span><span class="se">\n\n</span><span class="s2">To book a facility, please contact the facility management or use the booking system if available.&quot;</span>
        
        <span class="c1"># General help</span>
        <span class="k">return</span> <span class="s2">&quot;👋 **UTM Campus Assistant** can help you with:</span><span class="se">\n\n</span><span class="s2">• 🔍 **Find facilities** - Ask about locations and details</span><span class="se">\n</span><span class="s2">• 🔧 **Report issues** - Submit facility problems</span><span class="se">\n</span><span class="s2">• 📅 **Booking info** - Get booking information</span><span class="se">\n</span><span class="s2">• ℹ️ **General info** - Campus facility questions</span><span class="se">\n\n</span><span class="s2">What can I help you with today?&quot;</span>
    
<div class="viewcode-block" id="AIService.classify_issue_from_description">
<a class="viewcode-back" href="../api_reference.html#ai_service.AIService.classify_issue_from_description">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">classify_issue_from_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Classify issue type and priority from description&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Analyze this campus facility issue description and classify it according to the provided categories and priority levels.</span>

<span class="s2">            Description: &quot;</span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">            Classification Guidelines:</span>
<span class="s2">            1. Issue Type (choose one): electrical, hygiene, structural, equipment, security, other</span>
<span class="s2">               - Electrical: power outages, faulty wiring, lighting issues, HVAC electrical problems.</span>
<span class="s2">               - Hygiene: cleanliness, sanitation, waste management, pest control.</span>
<span class="s2">               - Structural: building damage (walls, roof, floor), leaks, broken fixtures (non-electrical), plumbing issues (burst pipes).</span>
<span class="s2">               - Equipment: broken machines (non-HVAC/electrical, e.g., lab equipment, kitchen appliances, projectors), computers, furniture, jammed doors (mechanical).</span>
<span class="s2">               - Security: access control issues, broken locks, safety concerns, unauthorized entry, fire alarm malfunctions.</span>
<span class="s2">               - Other: miscellaneous issues not fitting clear categories, general inquiries.</span>

<span class="s2">            2. Priority (choose one): low, medium, high, urgent</span>
<span class="s2">               - Urgent: Immediate safety hazards, critical infrastructure failure (e.g., campus-wide power outage, major flood, active security breach). Requires immediate attention, 24/7 response.</span>
<span class="s2">               - High: Major disruptions affecting many users or core operations (e.g., significant water leak in a common area, main server room AC failure, widespread network outage). Requires prompt attention, often within hours.</span>
<span class="s2">               - Medium: Moderate issues with some impact (e.g., a broken chair in an office, minor toilet clog, flickering light in one room, non-critical software bug). Can be addressed within a day or two.</span>
<span class="s2">               - Low: Minor issues with minimal impact (e.g., loose door handle, request for minor aesthetic repair, light bulb replacement in a less-used area). Can be addressed within a few days or weeks.</span>

<span class="s2">            Your response must be a valid JSON object. Do not include any text before or after the JSON.</span>
<span class="s2">            The JSON structure should be:</span>
<span class="s2">            </span><span class="se">{{</span>
<span class="s2">                &quot;issue_type&quot;: &quot;type_category_here&quot;,</span>
<span class="s2">                &quot;priority&quot;: &quot;priority_level_here&quot;,</span>
<span class="s2">                &quot;reasoning&quot;: &quot;brief explanation for the classification&quot;</span>
<span class="s2">            </span><span class="se">}}</span>
<span class="s2">            &quot;&quot;&quot;</span>
            
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_key</span> <span class="k">else</span> <span class="p">{}</span>

            <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deepseek_model</span><span class="p">,</span>
                <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an expert in campus facility management and issue classification. Always respond ONLY with valid JSON, strictly adhering to the specified schema. Do not include any conversational text or markdown code blocks (e.g., ```json).&quot;</span><span class="p">},</span>
                    <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}</span>
                <span class="p">],</span>
                <span class="s2">&quot;options&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                    <span class="s2">&quot;num_predict&quot;</span><span class="p">:</span> <span class="mi">300</span>
                <span class="p">},</span>
                <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="kc">False</span> <span class="c1"># Ensure full JSON response at once</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deepseek_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="c1"># Increased timeout</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            
            <span class="n">result_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="c1"># Correctly access content from Ollama&#39;s /api/chat response</span>
            <span class="c1"># model_raw_content = result_data.get(&quot;message&quot;, {}).get(&quot;content&quot;, &quot;&quot;)</span>

            <span class="c1"># For OpenRouter.ai: extract content from choices[0][&#39;message&#39;][&#39;content&#39;]</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">result_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;choices&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">model_raw_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">choices</span> <span class="ow">and</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">model_raw_content</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;message&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">model_raw_content</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model returned empty content for issue classification.&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_json_from_llm_response</span><span class="p">(</span><span class="n">model_raw_content</span><span class="p">)</span>

            <span class="c1"># Validate and normalize the parsed result</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issue_type&#39;</span><span class="p">,</span> <span class="s1">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;priority&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
                <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reasoning&#39;</span><span class="p">,</span> <span class="s1">&#39;No specific reasoning provided by model.&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error classifying issue: Request timed out.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="s1">&#39;Auto-classified: API request timed out.&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error communicating with Ollama API for issue classification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensure &#39;ollama serve&#39; is running and the model is available.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Auto-classified: API communication error (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing JSON from model response for issue classification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw model content was: &#39;</span><span class="si">{</span><span class="n">model_raw_content</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="c1"># Important for debugging</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Auto-classified: Invalid JSON response from model (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c1"># For &quot;Model returned empty content&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issue classification error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Auto-classified: Model output issue (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during issue classification: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;issue_type&#39;</span><span class="p">:</span> <span class="s1">&#39;other&#39;</span><span class="p">,</span> <span class="s1">&#39;priority&#39;</span><span class="p">:</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;reasoning&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Auto-classified: Unexpected internal error (</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">}</span></div>
</div>


<span class="c1"># Global AI service instance</span>
<span class="c1"># This line should ideally be placed in your main app file (e.g., app.py)</span>
<span class="c1"># after &#39;app&#39; and &#39;db&#39; are defined, or handled via Flask&#39;s application factory pattern.</span>
<span class="c1"># For now, it remains here, but be mindful of import order in your full application.</span>
<span class="n">ai_service</span> <span class="o">=</span> <span class="n">AIService</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, UTM Campus Assistant Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>